use bevy::{
    prelude::*,
    render::texture::{ImageLoaderSettings, ImageSampler, ImageSamplerDescriptor},
    utils::HashMap,
};

pub struct IconSetUiPlugin;

impl Plugin for IconSetUiPlugin {
    fn build(&self, app: &mut App) {
        app.init_resource::<IconSet>()
            .add_systems(PreStartup, load_icon_set);
    }
}

fn load_icon_set(asset_server: Res<AssetServer>, mut icon_set: ResMut<IconSet>) {
    const PIXEL_ICONS: &[&str] = &["selection_arrow", "attack_arrow", "hourglass"];
    const ICONS: &[&str] = &[
        // Weapons
        "axe",
        "bandage",
        "bow",
        "dagger",
        "mace",
        "sword",
        "whip",
        // Vfx
        "claw_mark",
        // Potions
        "fire_potion",
        "health_potion",
        "speed_potion",
        "strength_potion",
        // General
        "gold_coins",
        "population",
        "shop",
        "shop_character",
        "bg1",
        "bg2",
        "button1",
        "button1-gs",
        "heart",
    ];

    for pixel_icon in PIXEL_ICONS {
        info!("Loading pixel icon: {}", pixel_icon);
        let handle = asset_server.load_with_settings(
            format!("icons/{}.png", pixel_icon),
            |settings: &mut ImageLoaderSettings| {
                settings.sampler = ImageSampler::nearest();
            },
        );
        icon_set.insert(pixel_icon, handle);
    }

    for icon in ICONS {
        info!("Loading icon: {}", icon);
        let handle = asset_server.load(format!("icons/{}.png", icon));
        icon_set.insert(icon, handle);
    }
}

#[derive(Resource, Default)]
pub struct IconSet(HashMap<&'static str, Handle<Image>>);

impl IconSet {
    pub fn insert(&mut self, name: &'static str, handle: Handle<Image>) -> Option<Handle<Image>> {
        self.0.insert(name, handle)
    }

    /// Get cloned image handle.
    ///
    /// # Panic
    ///
    /// For ease of use, unwrap is used to panic if value does not exists for certain key.
    pub fn get(&self, name: &str) -> Handle<Image> {
        match self.0.get(name) {
            Some(handle) => handle.clone(),
            None => panic!("Unable to get icon: {name}"),
        }
    }
}
